#!/bin/bash

# This script lists the methods that aren't immediately preceded by a
# comment. The output is empty and the exit status is successful if they
# all have a comment.
#
# This is used in a test in project_spec.rb to ensure documentation
# coverage.

exec find lib -type f -name \*.rb ! -path lib/parsby/example/\* -exec awk '
  {
    if (/^\s*(class|module)\>/) {
      class_module = !def_seen && class_module ? class_module "\n" : ""
      class_module = class_module $0
      def_seen = 0
    } else {
      def_seen = 1
    }
  }

  /^\s*def / && !prev_line_is_comment {
    if (class_module) {
      print class_module
      class_module = ""
    }
    print
    at_least_one_missing = 1
  }

  {
    prev_line_is_comment = /^\s*#/
  }

  END {
    exit at_least_one_missing
  }
' {} +
